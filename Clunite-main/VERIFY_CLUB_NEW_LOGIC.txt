// New handleVerify function with multi-use PIN logic
const handleVerify = async (e: React.FormEvent) => {
  e.preventDefault()
  setLoading(true)

  try {
    // 1. Validate inputs
    if (!clubId) {
      toast.error("Club ID not found. Please use the link from club creation.")
      setLoading(false)
      return
    }

    if (pin.length !== 8) {
      toast.error("PIN must be exactly 8 digits")
      setLoading(false)
      return
    }

    // 2. Check authentication
    if (!authUser) {
      toast.error("You must be logged in to verify a club")
      setLoading(false)
      return
    }

    console.log('Verifying PIN for club:', clubId, 'User:', authUser.id)

    // 3. Ensure user exists in database
    const userSyncResult = await ensureUserExists(authUser, { college: clubData?.college })
    if (!userSyncResult.success) {
      console.error('Failed to sync user:', userSyncResult.error)
      toast.error("Failed to verify user account. Please try again.")
      setLoading(false)
      return
    }

    // 4. Get pending club with PIN
    const { data: pendingClub, error: verifyError } = await supabase
      .from('pending_clubs')
      .select('*')
      .eq('club_id', clubId)
      .eq('pin', pin)
      .single()

    if (verifyError || !pendingClub) {
      console.error('PIN verification error:', verifyError)
      if (verifyError?.code === 'PGRST116') {
        toast.error("Invalid PIN. Please check your email and try again.")
      } else {
        toast.error(`Verification error: ${verifyError?.message || 'Invalid PIN'}`)
      }
      setLoading(false)
      return
    }

    // 5. Check if PIN expired (48 hours)
    if (new Date(pendingClub.expires_at) < new Date()) {
      toast.error("PIN has expired (48 hours). Contact the club owner for an invite.")
      setLoading(false)
      return
    }

    // 6. Check usage limit (max 5 users)
    if (pendingClub.used_count >= (pendingClub.max_uses || 5)) {
      toast.error("PIN usage limit reached (max 5 users). Contact the club owner for an invite.")
      setLoading(false)
      return
    }

    // 7. Check if user already verified for this club
    const { data: existingMembership } = await supabase
      .from('club_memberships')
      .select('id')
      .eq('user_id', authUser.id)
      .eq('club_id', clubId)
      .single()

    if (existingMembership) {
      toast.error("You are already a member of this club")
      setLoading(false)
      return
    }

    // 8. Determine if user is owner (first to verify)
    const isOwner = pendingClub.used_count === 0

    console.log(isOwner ? 'User is the OWNER (first to verify)' : `User is admin #${pendingClub.used_count + 1}`)

    // 9. Add user as club admin
    const { error: membershipError } = await supabase
      .from('club_memberships')
      .insert({
        user_id: authUser.id,
        club_id: clubId,
        role: 'admin',
        is_owner: isOwner,
        verified_via_pin: true
      })

    if (membershipError) {
      console.error('Membership creation error:', membershipError)
      toast.error(`Failed to add as admin: ${membershipError.message}`)
      setLoading(false)
      return
    }

    // 10. Update pending_clubs usage tracking
    const updateData: any = {
      used_count: pendingClub.used_count + 1
    }

    // If first user, mark them as owner
    if (isOwner) {
      updateData.first_used_by = authUser.id
      updateData.first_used_at = new Date().toISOString()
      updateData.status = 'verified'
    }

    const { error: pendingUpdateError } = await supabase
      .from('pending_clubs')
      .update(updateData)
      .eq('club_id', clubId)

    if (pendingUpdateError) {
      console.error('Pending clubs update error:', pendingUpdateError)
      // Non-critical, continue
    }

    // 11. Update user role to organizer
    const { error: roleError } = await supabase
      .from('users')
      .update({ role: 'organizer' })
      .eq('id', authUser.id)

    if (roleError) {
      console.error('Role update error:', roleError)
      // Non-critical, continue
    }

    // 12. Log verification for audit trail
    await supabase
      .from('verification_logs')
      .insert({
        club_id: clubId,
        user_id: authUser.id,
        pin_used: pin,
        verified_at: new Date().toISOString()
      })
      .catch(err => console.error('Failed to log verification:', err))

    // 13. Success!
    setVerified(true)
    const message = isOwner 
      ? "Congratulations! You are the club owner. You now have full organizer access."
      : `Success! You are now an admin of ${clubName}. ${5 - (pendingClub.used_count + 1)} PIN uses remaining.`
    
    toast.success(message)
    
    // Redirect to organizer dashboard
    setTimeout(() => {
      window.location.href = '/dashboard/organizer'
    }, 2000)

  } catch (error: any) {
    console.error('Error verifying club:', error)
    toast.error(`Failed to verify club: ${error.message || 'Unknown error'}`)
  } finally {
    setLoading(false)
  }
}
